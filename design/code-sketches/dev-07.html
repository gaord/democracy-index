<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Document</title>
<style>

</style>
</head>
<body>

<script src="d3.min.js"></script>  
<script>

/*
rawCountryData = [
  {
    country/key: "string",
    indexScore: "int",
    indexCategory: "string",
    lat: "int",
    lng: "int"
  },
  ...
]

rawReligionData = [
  {
    country/key: "string",
    religion: "string",
    percent: "int",
    count: "int"
  },
  ...
]

formattedData = [
  {
    country/key: "string",
    indexScore: "int",
    indexCategory: "string",
    region: "string",
    lat: "int",
    lng: "int",
    values/religions: [
      {
        religion: "string",
        percent: "int",
        count: "int"
      },
      ...
    ]
  },
  ...
]
*/

rawCountryData = [
  {
    country: "foo",
    indexScore: 5,
    indexCategory: "one",
    lat: 1,
    lng: 1
  },
  {
    country: "bar",
    indexScore: 6,
    indexCategory: "one",
    lat: 2,
    lng: 2
  },
  {
    country: "baz",
    indexScore: 7,
    indexCategory: "one",
    lat: 3,
    lng: 3
  }
]

rawReligionData = [
  {country: "foo",religion: "apples",percent: .33,count: 33},
  {country: "foo",religion: "bananas",percent: .33,count: 33},
  {country: "foo",religion: "pears",percent: .33,count: 33},
  {country: "bar",religion: "apples",percent: .5,count: 50},
  {country: "bar",religion: "bananas",percent: .5,count: 50},
  {country: "baz",religion: "apples",percent: .75,count: 75},
  {country: "baz",religion: "pears",percent: .25,count: 25}
]

const dataJoined = rawReligionData.map(d=>{
    let c = rawCountryData.filter(j=>{
        return d.country === j.country;
      });
    d.indexScore = c[0].indexScore;
    d.indexCategory = c[0].indexCategory;
    d.lat = c[0].lat;
    d.lng = c[0].lng;
    return(d);
  })
  
const dataByCountry = d3.nest()
  .key(d=>d.country)
  .entries(dataJoined)
  .map(d=>{
    d.total = d3.sum(d.values, j=>j.count)
    return(d);
  })
  
// for map
console.group("data by coutry");
console.log(dataByCountry);
console.groupEnd();

// For bar charts
const dataByReligion = d3.nest()
  .key(d=>d.religion)
  .entries(dataJoined)

console.group("data by religion");
console.log(dataByReligion);
console.groupEnd();

</script>
</body>
</html>