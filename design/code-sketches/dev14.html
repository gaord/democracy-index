<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Document</title>
<style>

svg {
	background: #eee;
}

</style>
</head>
<body>
<div class="plot"></div>
<script src="d3.min.js"></script>  
<script>

const countryDataPromise = d3.json("democracy_religion_long.json");
countryDataPromise.then(data=>{

	const categories = d3.nest()
		.key(d=>d.indexCategory)
		.rollup(values=>d3.mean(values, d=>d.indexScore))
		.entries(data)
		.sort((a,b)=>a.value-b.value)
		.map(d=>{
			d.category = d.key;
			d.key = makeKey(d.key);
			delete d.values;
			return d;
		})

	const indexKeys = categories.map(d=>{
		return d.key;
	})


	religionData = d3.nest()
		.key(d=>d.religion)
		.entries(data)
		.map(d=>{
			categories.forEach(j=>{
				d[j.key] = getCategorySum(d.values,j.category)
			})
			const thisReligion = data.filter(j=>j.religion == d.key)
			const thisReligionSum = d3.sum(thisReligion,d=>d.religionPop);
			d.religionSum = thisReligionSum;
			return d;
		})
		.sort((a,b)=>a.religionSum-b.religionSum);
		
	maxN = getMax(religionData, indexKeys);
		

	colors=["red","orange","lime", "green"]

	nRows = religionData.length
	rowHeight = 30;
	rowMargin = 10;
	
	plotHeight = (nRows * rowHeight) + ((nRows - 1) * rowMargin)

	sy = d3.scaleBand()
		.domain(religionData.map(d=>d.key))
		.range([plotHeight,0])
		.paddingInner(rowMargin/rowHeight);

	sx = d3.scaleLinear()
		.domain([0,maxN])
		.range([0,500])

	stackGenerator = d3.stack()
		.keys(indexKeys)

	dom = d3.select(".plot")
		.append("svg")
		.attr("width",600)
		.attr("height",plotHeight)
		
	plot = dom.append("g")
		.attr("transform","translate(100,0)")

	g = plot.selectAll(".series")
		.data(stackGenerator(religionData))
		.enter()
		.append("g")
		.classed("series",true)
		.attr("fill",(d,i)=>colors[i])

	g.selectAll("rect")
		.data(d=>d)
		.enter()
		.append("rect")
		.attr("x",d=>sx(d[0])) // definitely right
		.attr("y",d=>sy(d.data.key))
		.attr("width",d=>sx(d[1])-sx(d[0]))
		.attr("height",sy.bandwidth())	

	 yAxis = d3.axisLeft()
		.scale(sy)
		.tickSize(0)


	dom.append("g")
		.attr("class", "y axis")
		.call(yAxis)
		.attr("transform","translate(100,0)")
		.select(".domain").remove()

	
});




function getCategorySum(data, category){
	const tmpData = data.filter(d=>d.indexCategory===category);
	const tmpSum = d3.sum(tmpData,d=>d.religionPop)
	return tmpSum;
}

function makeKey(str){
	const newStr = str.replace(/ /g,"").toLowerCase();
	return newStr
}

function getMax(data, keys){
	tmpData = data.map(d=>{
		d.rowNums = d3.sum(keys.map(j=>d[j]))
		return d;
	})
	return d3.max(tmpData,d=>d.rowNums);
}



</script>
</body>
</html>