<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Document</title>
<style>
* {font-family: sans-serif; font-size: 10px;}
/*div {margin: 2px; border: 1px dashed red; padding: 2px;}*/
h1 {font-size: 1em;}
.thing {margin: 2px; padding: 2px;background:pink;}
.wrapper {display: flex; flex-direction: row; flex-wrap: wrap}
.chart {margin: 0.5em; background: yellow; width: 200px; padding: 0.5em;}
.node {margin: 2px; padding: 2px; background: white;}
</style>
</head>
<body>
<div class="wrapper"></div>
<script src="d3.min.js"></script>
<script>

const voterPromise = d3.json("house-data.json");

voterPromise.then(data=>{

  const dom = d3.select(".wrapper");
  
  const districtsByState = d3.nest()
      .key(d =>d.state)
      .key(d =>d.district)
      .entries(data);

  function update(){
    let idx = Math.floor(Math.random()*districtsByState.length);
    drawOuter(dom, districtsByState[idx].values);
  }

  update();
  setInterval(update,1000);

});


function drawOuter(dom, data) {

  // bind, empty selection
  const nodes = dom.selectAll(".chart") 
    .data(data);

  // enter: append
  const nodesEnter = nodes.enter()
    .append("div")
    .attr("class","chart")
    .style("opactity",1)
    
  // merge: attr
  nodesEnter.merge(nodes)
    .text(d=>`${d.values[0].state}, district ${d.values[0].district}`)
    
  nodesEnter.merge(nodes)
    .each(function(d){
      drawSibling(this,[d.values[0]]);
      drawInner(this,d.values);
    })

  // exit: remove
  nodes.exit()
    .transition()
    .duration(500)
    .style("opacity",0)
    .remove();
    
}


function drawInner(dom,data){

  const plot = d3.select(dom)
    .append("div")
    .attr("class","thing")
    
  plot.append("h1")
    .text("district demographics")
    
  const nodes = plot.selectAll(".node") 
    .data(data, d=>d.voterEthnicity);

  // enter: append
  const nodesEnter = nodes.enter()
    .append("div")
    .attr("class","node")
    
  // merge: attr
  nodesEnter.merge(nodes)
    .text(d=>`${d.voterEthnicity}: ${d.voterEthnicityValue}`)
  
  // exit: remove
  nodes.exit()
    .remove();

}

function drawSibling(dom,data){

  const plot = d3.select(dom)
    .append("div")
    .attr("class","thing")
    
  const nodes = plot.selectAll(".node") 
    .data(data, d=>d.voterEthnicity);

  // enter: append
  const nodesEnter = nodes.enter()
    .append("div")
    .attr("class","node")
    
  // merge: attr
  nodesEnter.merge(nodes)
    .text(d=>`${d.id}`)
    .transition()
  
  // exit: remove
  nodes.exit()
    .remove();

}


 
</script>  
</body>
</html>