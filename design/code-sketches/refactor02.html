<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Document</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<h1>Title</h1>
<p>Intro ...</p>
<div id="cartogram"></div>
<div id="legend"></div>
<div id="axis"></div>
<div id="stackedbar"></div>
<footer class="footer">
	<p>Credits</p>
</footer>
<div class="stackedbar"></div>
<script src="d3.min.js"></script>  
<script>

// data

const countryDataPromise = d3.json("democracy_religion_long.json");

countryDataPromise.then(data=>{
	// set state
	renderReligionMenu(data);
	renderCategoryOptions(data);
	renderValueToggle();
	renderAxisToggle();
	renderCharts(data);
});

function filterByCountry(data,country){}

function getCategories(data){

	const categories = d3.nest()
		.key(d=>d.indexCategory)
		.rollup(values=>d3.mean(values, d=>d.indexScore))
		.entries(data)
		.sort((a,b)=>a.value-b.value)
		.map(d=>{
			d.category = d.key;
			d.key = makeKey(d.key);
			delete d.values;
			return d;
		});

	return categories;
	
}

function getCountryMapData(data){

	countryData = d3.nest()
		.key(d=>d.country)
		.entries(data)
		.map(d=>{
			d.indexScore = d.values[0].indexScore;
			d.indexCategory = d.values[0].indexCategory;
			d.allReligions = d.values[0].allReligions;
			d.lat = d.values[0].lat;
			d.lng = d.values[0].lng;
			return d
		})
		
	return countryData;
	
}

function getReligionMenuData(data){

	const religionData = d3.nest()
		.key(d=>d.religion)
		.entries(data)
		.map(d=>{
			const thisReligion = data.filter(j=>j.religion == d.key)
			const thisReligionSum = d3.sum(thisReligion,d=>d.religionPop);
			d.religionSum = thisReligionSum;
			return d;
		})
		.sort((a,b)=>b.religionSum-a.religionSum);
		
		return religionData;
}

function getReligionPlotData(data){

	const categories = getCategories(data);

	const religionData = d3.nest()
		.key(d=>d.religion)
		.entries(data)
		.map(d=>{
			categories.forEach(j=>{
				d[j.key] = getCategorySum(d.values,j.category)
			})
			const thisReligion = data.filter(j=>j.religion == d.key)
			const thisReligionSum = d3.sum(thisReligion,d=>d.religionPop);
			d.religionSum = thisReligionSum;
			return d;
		})
		.sort((a,b)=>a.religionSum-b.religionSum);
		
	return religionData;

}

function getCountryPlotData(data){



}



// application state

const GlobalState = {
	axisToggle: 1,
	metricToggle: 1,
	religion: "muslim"
}



// dispatch

const globalDispatch = d3.dispatch("change:religion", "change:axis", "change:metric","change:indexCategory");

globalDispatch.on('change:religion', () =>{})

globalDispatch.on('change:axis', () =>{})

globalDispatch.on('change:metric', () =>{})

globalDispatch.on('change:indexCategory', () =>{})



// ui

function renderReligionMenu(data){

	const religions = getReligionMenuData(data);
	const dom = d3.select("#legend")
		.append("div")
		.attr("class","country-menu")
		.append("select")
		.on("change",function(){
			// todo: replace with dispatch
			// console.log(this.checked)
			console.log(this.value)
		});

	const option = dom.selectAll("option")
		.data(religions);

	const optionEnter = option.enter()
		.append("option")
		// todo: check state object
		.attr("value",d=>d.key)
		.text(d=>unmakeKey(d.key));

}

function renderCategoryOptions(data){

	const categories = getCategories(data);
	const dom = d3.select("#legend")
		.append("div")
		.attr("class","category-options");

	const option = dom.selectAll(".option")
		.data(categories);

	const optionEnter = option.enter()
		.append("div")
		.attr("class","option");

	const widget = optionEnter
		.append("input")
		.attr("type","checkbox")
		.attr("id",d=>makeKey(d.key))
		// todo: read state object
		.attr("class",d=>`option-${makeKey(d.key)}`)
		.on("change",function(){
			// todo: replace with dispatch
			console.log(d3.select(this).attr("id"))
		});

	const label = optionEnter
		.append("label")
		.attr("for",d=>makeKey(d.key))
		.text(d=>d.key);
}

function renderValueToggle(){

	const dom = d3.select("#axis")
		.append("div")
		.attr("class","value-toggle")
		.append("input")
		.attr("type","checkbox")
		.attr("id","value-toggle")
		.on("change",function(){
			// todo: replace with dispatch
			// console.log(this.checked)
			console.log(d3.select(this).attr("id"))
		});
	
}

function renderAxisToggle(){

	const dom = d3.select("#axis")
		.append("div")
		.attr("class","axis-toggle")
		.append("input")
		.attr("type","checkbox")
		.attr("id","axis-toggle")
		.on("change",function(){
			// todo: replace with dispatch
			// console.log(this.checked)
			console.log(d3.select(this).attr("id"))
		});
			
}

// views

function renderCharts(data){

		// categories
		const categories = getCategories(data);

		// read state
		const religion = GlobalState.religion;
		
		// filter
		const filteredData = filterByCountry(data,religion);
		
//		if(GlobalState.axisToggle===1) {
//			const countryMapData = getCountryMapData(filteredData);
			renderPlot(data,categories);
			
//			renderCartogram(countryMapData);
//		} else {
//			let countryMapData = getCountryMapData(data);
//			const countryPlotData = getCountryPlotData(data)
//			renderPlot(countryPlotData);
//			renderCartogram(countryMapData);
//		}
			
}

function renderCartogram(data){

	// read state
	const metric = GlobalState.metricToggle;

	// set up
	const w = 600;
	const h = 300;

	// projection
	const projection = d3.geoEquirectangular()
		.scale((w/640)*100)
		.translate([w/2, h/2]);

	// data for force layout
	dataXY = countryData.map(d=>{
		d.x = projection([d.lng,d.lat])[0];
		d.y = projection([d.lng,d.lat])[1];
		return d;
	});

	// simulation
	const simulation = d3.forceSimulation(dataXY)
		.force('collision', d3.forceCollide().radius(5))
		.on('tick', ticked);

	// scale
	const sr = d3.scaleSqrt()
		.domain([0,getMax(data)])
		.range([0,30]);

	const plot = d3.select("#cartogram")
		.append("svg")
		.attr("width",w)
		.attr("height",h);

	// labels
	const labels = [
			{txt:"North America",lat:32.7865,lng:-97.1148},
			{txt:"South America",lat:-8.7832,lng:-55.4915},
			{txt:"Europe",lat:48.8789,lng:2.32335},
			{txt:"Africa",lat:-8.7832,lng:34.5085},
			{txt:"Asia",lat:34.0479,lng:100.6197}
		];

	plot.selectAll("text")
		.data(labels)
		.enter()
		.append("text")
		.attr("x",d=>projection([d.lng,d.lat])[0])
		.attr("y",d=>projection([d.lng,d.lat])[1])
		.text(d=>d.txt)
		.attr("class","cartogram-label")
		.attr("text-anchor","middle")

	// force layout dots
	function ticked() {
		const dots = plot.selectAll("circle")
			.data(dataXY);

		const dotsEnter = dots.enter()
			.append("circle");

		dots.merge(dotsEnter)
			.attr("cx",d=>d.x)
			.attr("cy",d=>d.y)
			// todo: scale radius
			.attr("r", 5)
			.attr("fill","red")
			.attr("opacity",0.5)
			.attr("data-country",d=>d.country)

		dots.exit()
			.remove();

	}		

}

function renderPlot(data){

	const religionPlotData = getReligionPlotData(data)

	const categories = getCategories(data)
	
	const indexKeys = categories.map(d=>{
		return d.key;
	})

	const maxN = getMax(data, indexKeys);
	
	const nRows = religionPlotData.length
	const rowHeight = 15;
	const rowMargin = 5;
	
	const plotHeight = (nRows * rowHeight) + ((nRows - 1) * rowMargin)

	sy = d3.scaleBand()
		.domain(data.map(d=>d.key))
		.range([plotHeight,0])
		.paddingInner(rowMargin/rowHeight);

	sx = d3.scaleLinear()
		.domain([0,maxN])
		.range([0,500])

	// todo: abstract
	colors=["red","orange","lime", "green"]

	stackGenerator = d3.stack()
		.keys(indexKeys)

	const dom = d3.select("#stackedbar")
		.append("svg")
		.attr("width",600)
		.attr("height",plotHeight)

	const plot = dom.append("g")
		.attr("transform","translate(100,0)")

	const bars = plot.selectAll(".series")
		.data(stackGenerator(data))
		.enter()
		.append("g")
		.classed("series",true)
		.attr("fill",(d,i)=>colors[i])

	bars.selectAll("rect")
		.data(d=>d)
		.enter()
		.append("rect")
		.attr("x",d=>sx(d[0])) // definitely right
		.attr("y",d=>sy(d.data.key))
		.attr("width",d=>sx(d[1])-sx(d[0]))
		.attr("height",sy.bandwidth())	



//		// read state
//		const metric = GlobalState.metricToggle;
//		// setup data
//		if (metric === 1) {
//		} else {
//		}


		
}



// utilty

function getMax(data,keys){

	const religionData = getReligionPlotData(data);

	tmpData = religionData.map(d=>{
		d.rowNums = d3.sum(keys.map(j=>d[j]))
		return d;
	});
	
	return d3.max(tmpData,d=>d.rowNums);
}

function getCategorySum(data, category){
	const tmpData = data.filter(d=>d.indexCategory===category);
	const tmpSum = d3.sum(tmpData,d=>d.religionPop);
	return tmpSum;
}

function makeKey(str){
	const newStr = str.replace(/ /g,"").toLowerCase();
	return newStr;
}

function unmakeKey(str){
	const newStr = str.replace(/([A-Z])/g, " $1")
		.trim()
		.replace(/\b\w/g, l => l.toUpperCase());
	return newStr;
}


</script>
</body>
</html>