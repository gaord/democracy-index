<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Document</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<h1>Title</h1>
<p>Intro ...</p>
<div id="cartogram"></div>
<div id="legend"></div>
<div id="axis"></div>
<footer class="footer">
	<p>Credits</p>
</footer>
<div class="stackedbar"></div>
<script src="d3.min.js"></script>  
<script>

// data

const countryDataPromise = d3.json("democracy_religion_long.json");

countryDataPromise.then(data=>{

	/*{
	 *  country:"",
	 *	code: ",
	 *  lgn:"",
	 *  lat:"",
	 *  indexScore:0,
	 *  indexCategory:"",
	 *  religion:"",
	 *	allReligions:0,
	 *  religionPct:0,
	 *  religionPop:0
	 }*/

	// raw
  // console.log(data)
	
	// getCountryData
	const countryData = getCountryData(data);
	// console.log(countryData)

	// getReligionData
	const religionData = getReligionData(data);
	// console.log(religionData)

	// getIndexData
	const indexData = getIndexData(data);
	// console.log(indexData)


	renderReligionBarChart(religionData);


});

function getCountryData(data){

	const countryData = d3.nest()
		.key(d=>d.code)
		.entries(data)
		.map(d=>{
			d.country = d.values[0].country;
			d.lat = d.values[0].lat;
			d.lng = d.values[0].lng;
			d.indexScore = d.values[0].indexScore;
			d.indexCategory = d.values[0].indexCategory;
			d.allReligions = d.values[0].allReligions;
			return d;
		})
		.sort((a,b)=>b.allReligions-a.allReligions);
		
		return countryData;
}

function getReligionData(data){

	const religionData = d3.nest()
		.key(d=>d.religion)
		.entries(data)
		.map(d=>{
			const thisReligion = data.filter(j=>j.religion == d.key)
			const thisReligionSum = d3.sum(thisReligion,d=>d.religionPop);
			d.religionSum = thisReligionSum;
			return d;
		})
		.sort((a,b)=>b.religionSum-a.religionSum);
		
		return religionData;
}

function getIndexData(data){

	const indexData = d3.nest()
		.key(d=>d.indexCategory)
		.rollup(values=>d3.mean(values, d=>d.indexScore))
		.entries(data)
		.sort((a,b)=>a.value-b.value);
		
	return indexData;

}



// application state

const countrySelection = "United States";
const axisToggle = 1;
const metricToggle = 1;
// question: how do I make this automatically on load?
const filterStates = {
        "authoritarian":1,
        "hybridregime":1,
        "flaweddemocracy":1,
        "fulldemocracy":1
      };



// dispatch

const globalDispatch = d3.dispatch("change:country", "change:axis", "change:metric","change:filter");

globalDispatch.on('change:country', () =>{

})

globalDispatch.on('change:axis', () =>{

})

globalDispatch.on('change:metric', () =>{

})

globalDispatch.on('change:filter', () =>{

})



// ui

function renderCategoryOptions(){

	countryDataPromise.then(data=>{
			
		const categories = getIndexData(data);
		const dom = d3.select("#legend")
			.append("div")
			.attr("class","category-options");

		const option = dom.selectAll(".option")
			.data(categories)

		const optionEnter = option.enter()
			.append("div")
			.attr("class","option");

		const widget = optionEnter
			.append("input")
			.attr("type","checkbox")
			.attr("id",d=>makeKey(d.key))
			// todo: read state object
			.attr("class",d=>`option-${makeKey(d.key)}`)
			.on("change",function(){
				// todo: replace with dispatch
				// console.log(this.checked)
				console.log(d3.select(this).attr("id"))
			});

		const label = optionEnter
			.append("label")
			.attr("for",d=>makeKey(d.key))
			.text(d=>d.key);
				
	})
}

function renderValueToggle(){

	const dom = d3.select("#axis")
		.append("div")
		.attr("class","value-toggle")
		.append("input")
		.attr("type","checkbox")
		.attr("id","value-toggle")
		.on("change",function(){
			// todo: replace with dispatch
			// console.log(this.checked)
			console.log(d3.select(this).attr("id"))
		});
	
}

function renderAxisToggle(){

	const dom = d3.select("#axis")
		.append("div")
		.attr("class","axis-toggle")
		.append("input")
		.attr("type","checkbox")
		.attr("id","axis-toggle")
		.on("change",function(){
			// todo: replace with dispatch
			// console.log(this.checked)
			console.log(d3.select(this).attr("id"))
		});
			
}

function renderCountryMenu(){

	countryDataPromise.then(data=>{
	
		const countries = getCountryData(data);
		const dom = d3.select("#legend")
			.append("div")
			.attr("class","country-menu")
			.append("select")
			.on("change",function(){
				// todo: replace with dispatch
				// console.log(this.checked)
				console.log(this.value)
			});

		const option = dom.selectAll("option")
			.data(countries);

		const optionEnter = option.enter()
			.append("option")
			// todo: check state object
			.attr("value",d=>d.key)
			.text(d=>d.country);
			
	});
}



// display

function renderReligionBarChart(data){
	
		console.log(data);
		
		const barData = data

//  const nrows = 0;
//  const rowHeight = 0;
//  const rowMargin = 0; // total = rowHeight + rowMargin
  // scale svg to data
}


function renderCartogram(data){

}


// modules

function StackedBar(data){
  //[{
  //  key:"",
  //  label:"",
  //  value:0,
  //  color:""
  //}]
}

function Cartogram(data){
  //[{
  //  key:"",
  //  lon:0,
  //  lat:0,
  //  value:0,
  //  color:""
  //}]
}



// utilty

function makeKey(str){
	const newStr = str.replace(/ /g,"").toLowerCase();
	return newStr
}



</script>
</body>
</html>