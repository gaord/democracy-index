<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Document</title>
<style>
.plot {margin: 2em; background-color: #eee;}
</style>
</head>
<body>
<div class="plot"></div>
<script src="d3.min.js"></script>  
<script>

// working stacked bar charts for composition

const dataRaw = [
  {key:"cat1",color:"red",value:5},
  {key:"cat1",color:"blue",value:4},
  {key:"cat1",color:"green",value:2},
  {key:"cat2",color:"red",value:1},
  {key:"cat2",color:"blue",value:3},
  {key:"cat2",color:"green",value:4},
  {key:"cat3",color:"red",value:1},
  {key:"cat3",color:"blue",value:1}
]

const dataNested = d3.nest()
  .key(d => d.key)
  .entries(dataRaw)
  .map(d=>{
    d.total = d3.sum(d.values,d=>d.value)
    d.values = d.values.map(j=>{
      j.pct = j.value / d.total;
      return j;
    })
    return d;
  })
  
const mm = d3.nest()
  .key(d=>d.key)
  .rollup(values => d3.sum(values, d => d.value))
  .entries(dataRaw)

const W = 400;
const H = 300;
const m = {t: 20, r: 20, b: 20, l: 20};
const w = W - m.l - m.r;
const h = H - m.t - m.b;

var x = d3.scaleOrdinal().range([0, w]);
var y = d3.scaleLinear().range([h, 0]);

const svg = d3.select(".plot")
  .style("width",`${W}px`)
  .style("height",`${H}px`)
  .append("svg")
  .attr("width", w + m.l + m.r)
  .attr("height", h + m.t + m.b)
  .append("g")
  .attr("transform", `translate(${m.l},${m.t})`);

const sx = d3.scaleLinear()
  .domain([0, 1])
  .rangeRound([0,w]);  


const plot = svg.selectAll(".line")
  .data(dataNested)
  .enter()
  .append("g")
  .attr("class","line")
  .attr("transform",(d,i)=>{
    let ydist = i * 30;
    return `translate(0,${ydist})`
  })
  .each(function(d){
    d3.select(this)
      .selectAll(".bar")
      .data(d=>d.values)
      .enter()
        .append("rect")
        .attr("class","bar")
        .attr("x",(j,i)=>sx(d3.sum(d.values.slice(0,i),j=>j.pct)))
        .attr("y",0)
        .attr("width",j=>sx(j.pct))
        .attr("height",20)
        .attr("fill",j=>j.color)
  })

</script>  
</body>
</html>